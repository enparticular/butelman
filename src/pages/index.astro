---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import EventCard from '../components/EventCard.astro';
import ProjectCard from '../components/ProjectCard.astro';

// Get all events, sorted by date
const events: CollectionEntry<'events'>[] = await getCollection('events');
const sortedEvents = events.sort((a, b) => 
  b.data.date.getTime() - a.data.date.getTime()
);

// Get all projects and separate by category
const projects: CollectionEntry<'projects'>[] = await getCollection('projects');

// Filter and sort music projects
const musicProjects = projects
  .filter(p => p.data.category === 'music')
  .sort((a, b) => {
    if (a.data.order !== undefined && b.data.order !== undefined) {
      return a.data.order - b.data.order;
    } else if (a.data.order !== undefined) {
      return -1;
    } else if (b.data.order !== undefined) {
      return 1;
    }
    return 0;
  });

// Filter and sort cinema/theater projects
const cinemaTheaterProjects = projects
  .filter(p => p.data.category === 'cinema/theater')
  .sort((a, b) => {
    if (a.data.order !== undefined && b.data.order !== undefined) {
      return a.data.order - b.data.order;
    } else if (a.data.order !== undefined) {
      return -1;
    } else if (b.data.order !== undefined) {
      return 1;
    }
    return 0;
  });

// Get the biography page
const pages: CollectionEntry<'pages'>[] = await getCollection('pages');
const biografiaPage = pages.find(p => p.slug === 'biografia');

// Render the biography content if it exists
const biografiaRendered = biografiaPage ? await biografiaPage.render() : null;
---

<Layout title="Home">
  <main class="min-h-screen">
    <section class="bg-gradient-to-r from-blue-600 to-purple-600 text-white py-20">
      <div class="container">
        <h1 class="text-5xl font-bold mb-4">Pablo Butelman</h1>
      </div>
    </section>
    
    <section class="py-16">
      <div class="container">
        <h2 class="text-3xl font-bold mb-8 text-gray-800">Workshops / Recitales</h2>
        <div class="space-y-6 mb-8">
          {sortedEvents.map(event => (
            <EventCard event={event} />
          ))}
        </div>
        <a href="/events" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors">View all events</a>
      </div>
    </section>
    
    <section class="py-16 bg-white">
      <div class="container">
        <h2 class="text-3xl font-bold mb-8 text-gray-800">Discos</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
          {musicProjects.map(project => (
            <ProjectCard project={project} />
          ))}
        </div>
      </div>
    </section>
    
    <section class="py-16 bg-gray-50">
      <div class="container">
        <h2 class="text-3xl font-bold mb-8 text-gray-800">Cine / Teatro</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
          {cinemaTheaterProjects.map(project => (
            <ProjectCard project={project} />
          ))}
        </div>
      </div>
    </section>
    
    {biografiaPage && biografiaRendered && (
      <section class="py-16 bg-white">
        <div class="container">
          <h2 class="text-3xl font-bold mb-8 text-gray-800">{biografiaPage.data.title}</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            {biografiaPage.data.image && (
              <div class="md:col-span-1">
                <img 
                  src={biografiaPage.data.image.src} 
                  alt={biografiaPage.data.image.alt} 
                  class="w-full rounded-lg shadow-md"
                />
              </div>
            )}
            <div class={biografiaPage.data.image ? "md:col-span-2" : "md:col-span-3"}>
              <div class="prose prose-lg max-w-none text-gray-700 leading-relaxed space-y-4">
                <biografiaRendered.Content />
              </div>
            </div>
          </div>
        </div>
      </section>
    )}
    
    <section class="py-8 bg-gray-50">
      <div class="container text-center">
        <a href="/projects" class="inline-block bg-purple-600 hover:bg-purple-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors">View all projects</a>
      </div>
    </section>
  </main>
</Layout>