---
import Layout from '../layouts/Layout.astro';
import { getCollection } from 'astro:content';
import type { CollectionEntry } from 'astro:content';
import EventCard from '../components/EventCard.astro';
import ProjectCard from '../components/ProjectCard.astro';

// Get all events, sorted by date
const events: CollectionEntry<'events'>[] = await getCollection('events');
const sortedEvents = events.sort((a, b) => 
  b.data.date.getTime() - a.data.date.getTime()
);

// Get all projects and separate by category
const projects: CollectionEntry<'projects'>[] = await getCollection('projects');

// Filter and sort music projects
const musicProjects = projects
  .filter(p => p.data.category === 'music')
  .sort((a, b) => {
    if (a.data.order !== undefined && b.data.order !== undefined) {
      return a.data.order - b.data.order;
    } else if (a.data.order !== undefined) {
      return -1;
    } else if (b.data.order !== undefined) {
      return 1;
    }
    return 0;
  });

// Filter and sort cinema/theater projects
const cinemaTheaterProjects = projects
  .filter(p => p.data.category === 'cinema/theater')
  .sort((a, b) => {
    if (a.data.order !== undefined && b.data.order !== undefined) {
      return a.data.order - b.data.order;
    } else if (a.data.order !== undefined) {
      return -1;
    } else if (b.data.order !== undefined) {
      return 1;
    }
    return 0;
  });

// Get the biography page
const pages: CollectionEntry<'pages'>[] = await getCollection('pages');
const biografiaPage = pages.find(p => p.slug === 'biografia');

// Render the biography content if it exists
const biografiaRendered = biografiaPage ? await biografiaPage.render() : null;
---

<Layout title="Home">
  <main class="min-h-screen">
    <section class="bg-gradient-to-r from-blue-600 to-purple-600 text-white py-20">
      <div class="container">
        <div class="flex items-center justify-between mb-6 md:mb-0">
          <h1 class="text-5xl font-bold">Pablo Butelman</h1>
          
          <!-- Mobile menu button -->
          <button id="mobile-menu-btn" class="md:hidden text-white p-2" aria-label="Toggle menu">
            <svg class="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
          </button>
        </div>
        
        <!-- Desktop Navigation -->
        <nav class="hidden md:block mt-6">
          <ul class="flex gap-6 text-lg">
            <li><a href="#workshops" class="hover:underline transition-all">Workshops</a></li>
            <li><a href="#discos" class="hover:underline transition-all">Discos</a></li>
            <li><a href="#cine" class="hover:underline transition-all">Cine</a></li>
            <li><a href="#biografia" class="hover:underline transition-all">Biografía</a></li>
          </ul>
        </nav>
      </div>
    </section>
    
    <!-- Mobile Navigation -->
    <nav id="mobile-menu" class="hidden md:hidden bg-white shadow-lg">
      <ul class="flex flex-col">
        <li><a href="#workshops" class="block px-6 py-4 hover:bg-gray-100 transition-colors mobile-nav-link">Workshops</a></li>
        <li><a href="#discos" class="block px-6 py-4 hover:bg-gray-100 transition-colors mobile-nav-link">Discos</a></li>
        <li><a href="#cine" class="block px-6 py-4 hover:bg-gray-100 transition-colors mobile-nav-link">Cine</a></li>
        <li><a href="#biografia" class="block px-6 py-4 hover:bg-gray-100 transition-colors mobile-nav-link">Biografía</a></li>
      </ul>
    </nav>
    
    <section id="workshops" class="py-16 scroll-mt-20">
      <div class="container">
        <h2 class="text-3xl font-bold mb-8 text-gray-800">Workshops / Recitales</h2>
        <div class="space-y-6 mb-8">
          {sortedEvents.map(event => (
            <EventCard event={event} />
          ))}
        </div>
        <a href="/events" class="inline-block bg-blue-600 hover:bg-blue-700 text-white font-semibold px-6 py-3 rounded-lg transition-colors">View all events</a>
      </div>
    </section>
    
    <section id="discos" class="py-16 bg-white scroll-mt-20">
      <div class="container">
        <h2 class="text-3xl font-bold mb-8 text-gray-800">Discos</h2>
        
        <!-- Tag Filters -->
        <div class="mb-8">
          <div class="flex flex-wrap gap-3">
            <button 
              data-tag="composición" 
              class="tag-filter px-4 py-2 rounded-full font-medium transition-colors bg-blue-600 text-white hover:bg-blue-700"
            >
              Composición
            </button>
            <button 
              data-tag="intérprete" 
              class="tag-filter px-4 py-2 rounded-full font-medium transition-colors bg-blue-600 text-white hover:bg-blue-700"
            >
              Intérprete
            </button>
            <button 
              data-tag="producción" 
              class="tag-filter px-4 py-2 rounded-full font-medium transition-colors bg-blue-600 text-white hover:bg-blue-700"
            >
              Producción
            </button>
            <button 
              data-tag="arreglos" 
              class="tag-filter px-4 py-2 rounded-full font-medium transition-colors bg-blue-600 text-white hover:bg-blue-700"
            >
              Arreglos
            </button>
          </div>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8" id="music-projects-grid">
          {musicProjects.map(project => (
            <div 
              class="music-project-item" 
              data-tags={JSON.stringify(project.data.tags || [])}
            >
              <ProjectCard project={project} />
            </div>
          ))}
        </div>
      </div>
    </section>
    
    <section id="cine" class="py-16 bg-gray-50 scroll-mt-20">
      <div class="container">
        <h2 class="text-3xl font-bold mb-8 text-gray-800">Cine / Teatro</h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
          {cinemaTheaterProjects.map(project => (
            <ProjectCard project={project} />
          ))}
        </div>
      </div>
    </section>
    
    {biografiaPage && biografiaRendered && (
      <section id="biografia" class="py-16 bg-white scroll-mt-20">
        <div class="container">
          <h2 class="text-3xl font-bold mb-8 text-gray-800">{biografiaPage.data.title}</h2>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
            {biografiaPage.data.image && (
              <div class="md:col-span-1">
                <img 
                  src={biografiaPage.data.image.src} 
                  alt={biografiaPage.data.image.alt} 
                  class="w-full rounded-lg shadow-md"
                />
              </div>
            )}
            <div class={biografiaPage.data.image ? "md:col-span-2" : "md:col-span-3"}>
              <div class="prose prose-lg max-w-none text-gray-700 leading-relaxed space-y-4">
                <biografiaRendered.Content />
              </div>
            </div>
          </div>
        </div>
      </section>
    )}
    
  </main>
</Layout>

<script>
  // Mobile menu toggle
  const mobileMenuBtn = document.getElementById('mobile-menu-btn');
  const mobileMenu = document.getElementById('mobile-menu');
  
  if (mobileMenuBtn && mobileMenu) {
    mobileMenuBtn.addEventListener('click', () => {
      mobileMenu.classList.toggle('hidden');
    });
    
    // Close mobile menu when clicking a link
    const mobileNavLinks = document.querySelectorAll('.mobile-nav-link');
    mobileNavLinks.forEach(link => {
      link.addEventListener('click', () => {
        mobileMenu.classList.add('hidden');
      });
    });
  }
  
  // Smooth scroll for anchor links
  document.querySelectorAll<HTMLAnchorElement>('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', (e: Event) => {
      e.preventDefault();
      const targetId = anchor.getAttribute('href');
      if (targetId && targetId !== '#') {
        const targetElement = document.querySelector(targetId);
        if (targetElement) {
          targetElement.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
      }
    });
  });
  
  // Tag filtering system
  const tagFilters = document.querySelectorAll<HTMLButtonElement>('.tag-filter');
  const activeTags = new Set<string>(['composición', 'intérprete', 'producción', 'arreglos']);
  
  function filterProjects() {
    const projectItems = document.querySelectorAll<HTMLElement>('.music-project-item');
    
    projectItems.forEach(item => {
      const projectTagsAttr = item.getAttribute('data-tags');
      if (!projectTagsAttr) {
        item.style.display = 'none';
        return;
      }
      
      const projectTags: string[] = JSON.parse(projectTagsAttr);
      
      // Show project if it has at least one active tag
      const hasActiveTag = projectTags.some(tag => activeTags.has(tag));
      
      if (hasActiveTag) {
        item.style.display = 'block';
      } else {
        item.style.display = 'none';
      }
    });
  }
  
  tagFilters.forEach(button => {
    button.addEventListener('click', () => {
      const tag = button.getAttribute('data-tag');
      if (!tag) return;
      
      if (activeTags.has(tag)) {
        // Deactivate tag
        activeTags.delete(tag);
        button.classList.remove('bg-blue-600', 'text-white', 'hover:bg-blue-700');
        button.classList.add('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
      } else {
        // Activate tag
        activeTags.add(tag);
        button.classList.remove('bg-gray-200', 'text-gray-700', 'hover:bg-gray-300');
        button.classList.add('bg-blue-600', 'text-white', 'hover:bg-blue-700');
      }
      
      filterProjects();
    });
  });
</script>